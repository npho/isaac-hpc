# isaac-sim.def by Nam Pho

# https://catalog.ngc.nvidia.com/orgs/nvidia/collections/cuda_toolkit/artifacts

### From scratch
#Bootstrap: docker
#From: nvcr.io/nvidia/cuda:{{ CONTAINER_TAG }}

### From local container
Bootstrap: localimage
From: rocky9_cuda-dev-12.8.1.sif
#From: ubuntu22.04_cuda-dev-12.9.1.sif

%arguments
    CONTAINER_TAG=12.8.1-devel-rockylinux9
    ISAAC_VERSION=4.5.0
    SRC=/usr/local/src/

%labels
    Author npho@uw.edu
    Version {{ ISAAC_VERSION }}

%help
    An Apptainer native implementation of Isaac Sim.

%setup
    if [ -f "vulkan.run" ]; then
        echo "Vulkan drivers exist!"
    else
        echo "Downloading Vulkan drivers..."
        # https://www.nvidia.com/en-us/drivers/details/247720/
        curl -o vulkan.run https://us.download.nvidia.com/XFree86/Linux-x86_64/570.169/NVIDIA-Linux-x86_64-570.169.run
    fi

%files
    requirements.txt {{ SRC }}
    test.sh /opt/
    sim.py /opt/

%post
    # Install supporting packages
    dnf clean all
    dnf update -y \
    	glibc

    dnf install -y \
    	glib2-devel \
	libGLU \
	libglvnd-glx \
    	libSM \
	libX11 \
	libXext \
	libXrender \
	libXt \
	libXtst \
	mesa-libGL \
	mesa-vulkan-drivers \
	vulkan-loader \
	vulkan-tools \
	which \
	xorg-x11-server-Xorg \
	xorg-x11-server-Xvfb \
	xorg-x11-utils \
	xorg-x11-xauth \
	zenity \
	zsh

    dnf -y update glibc # Isaac Sim 4.5.0 requires GLIBC 2.35+

    # Setup uv for Python stuff
    mkdir -p /opt/uv/bin/
    export UV_INSTALL_DIR=/opt/uv/bin/
    curl -LsSf https://astral.sh/uv/install.sh | sh
    export PATH=/opt/uv/bin/:${PATH}

    # UV parameters
    # https://docs.astral.sh/uv/reference/environment/
    UV_CONCURRENT_DOWNLOADS=100
    UV_CONCURRENT_BUILDS=100
    UV_CONCURRENT_INSTALLS=100
    UV_COMPILE_BYTECODE=True

    # Python environment setup
    uv python install 3.10 # Isaac Sim 4.5.0 requires Python 3.11
    mkdir -p /opt/python/isaac
    cd /opt/python/isaac

    export ACCEPT_EULA=Y
    export OMNI_KIT_ACCEPT_EULA=YES
    uv venv --relocatable --prompt isaac
    uv pip install \
       --torch-backend cu128 \
       --index https://download.pytorch.org/whl/cu128 \
       --index https://pypi.nvidia.com \
       -r {{ SRC }}/requirements.txt
    source .venv/bin/activate
    
    # Clean up
    rm -vfr {{ SRC }}/*
    dnf clean all
    #apt cache clean
    #apt clean
    #apt --purge autoremove

%runscript
    source /opt/python/isaac/.venv/bin/activate

%environment
    export ACCEPT_EULA=Y
    export OMNI_KIT_ACCEPT_EULA=YES
    export PATH=/opt/uv/bin/:${PATH}
