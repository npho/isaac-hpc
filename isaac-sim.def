# isaac-sim.def by Nam Pho

# https://catalog.ngc.nvidia.com/orgs/nvidia/collections/cuda_toolkit/artifacts

### From scratch
#Bootstrap: docker
#From: nvcr.io/nvidia/cuda:{{ CONTAINER_TAG }}

### From local container
Bootstrap: localimage
From: rocky9_cuda-dev-12.9.1.sif
#From: ubuntu22.04_cuda-dev-12.9.1.sif

%arguments
    CONTAINER_TAG=12.9.1-devel-rockylinux9
    ISAAC_VERSION=4.5.0
    SRC=/usr/local/src/

%labels
    Author npho@uw.edu
    Version {{ ISAAC_VERSION }}

%help
    An Apptainer native implementation of Isaac Sim.

%files
    requirements.txt {{ SRC }}
    test.* /opt/

%post
    # Install supporting packages
    dnf clean all
    dnf update -y \
    	glibc
    dnf install -y \
    	glib2-devel \
	libGLU \
    	libSM \
	libXext \
	libXrender \
	libXtst \
	mesa-libGL \
	which \
	zenity \
	zsh

    dnf -y update glibc # Isaac Sim 4.5.0 requires GLIBC 2.35+

    # Setup uv for Python stuff
    mkdir -p /opt/uv/bin/
    export UV_INSTALL_DIR=/opt/uv/bin/
    curl -LsSf https://astral.sh/uv/install.sh | sh
    export PATH=/opt/uv/bin/:${PATH}
    
    # Python environment setup
    uv python install 3.10 # Isaac Sim 4.5.0 requires Python 3.11
    mkdir -p /opt/python/isaac
    cd /opt/python/isaac

    export ACCEPT_EULA=Y
    export OMNI_KIT_ACCEPT_EULA=YES
    export UV_INDEX=https://pypi.nvidia.com
    uv venv --relocatable --prompt isaac
    uv pip install --torch-backend cu128 -r {{ SRC }}/requirements.txt
    source .venv/bin/activate
    
    # Clean up
    rm -vfr {{ SRC }}/*
    dnf clean all
    #apt cache clean
    #apt clean
    #apt --purge autoremove

%environment
    export ACCEPT_EULA=Y
    export OMNI_KIT_ACCEPT_EULA=YES
    export PATH=/opt/uv/bin/:${PATH}
